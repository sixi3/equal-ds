name: ğŸ¨ Auto-Sync Design Tokens & Storybook

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'tokens.json'
      - 'design-tokens.config.js'
      - 'figma-assets/**'
      - '.github/workflows/auto-sync-tokens.yml'
  workflow_dispatch: # Allow manual trigger
    inputs:
      force_sync:
        description: 'Force sync even if no token changes'
        required: false
        default: false
        type: boolean

jobs:
  auto-sync:
    name: ğŸ”„ Auto-Sync Everything
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0 # Full history for better diff detection
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed"
      
      - name: ğŸ” Check for token changes
        id: check-changes
        run: |
          # Check if tokens.json changed in this push
          if git diff --name-only HEAD~1 HEAD | grep -q "tokens.json"; then
            echo "TOKENS_CHANGED=true" >> $GITHUB_OUTPUT
            echo "ğŸ¨ Design tokens changed - will sync everything"
          else
            echo "TOKENS_CHANGED=false" >> $GITHUB_OUTPUT
            echo "ğŸ“ No token changes detected"
          fi
          
          # Check if force sync is requested
          if [[ "${{ github.event.inputs.force_sync }}" == "true" ]]; then
            echo "TOKENS_CHANGED=true" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Force sync requested - will sync everything"
          fi
      
      - name: ğŸ” Setup Figma Access (if tokens changed)
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true'
        run: |
          # Check if we have Figma access token
          if [[ -n "${{ secrets.FIGMA_ACCESS_TOKEN }}" ]]; then
            echo "âœ… Figma access token available"
          else
            echo "âš ï¸  No Figma access token - will use local tokens only"
          fi
      
      - name: ğŸ“¡ Sync design tokens
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true'
        run: |
          echo "ğŸ”„ Syncing design tokens..."
          if [[ -n "${{ secrets.FIGMA_ACCESS_TOKEN }}" ]]; then
            # Set Figma token for design-tokens-sync
            export FIGMA_ACCESS_TOKEN="${{ secrets.FIGMA_ACCESS_TOKEN }}"
            npm run tokens:sync
          else
            echo "ğŸ“ Using local tokens only (no Figma sync)"
            # Still generate controls from local tokens
            npm run generate:controls
          fi
          echo "âœ… Tokens synced"
      
      - name: âš™ï¸ Generate Storybook controls
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true'
        run: |
          echo "âš™ï¸ Generating Storybook controls..."
          npm run generate:controls
          echo "âœ… Controls generated"
      
      - name: ğŸ“ Auto-update Storybook stories
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true'
        run: |
          echo "ğŸ“ Updating Storybook stories..."
          npm run auto:update
          echo "âœ… Stories updated"
      
      - name: ğŸ” Check for actual changes
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true'
        id: check-actual-changes
        run: |
          # Check if any files actually changed after sync
          if git diff --quiet; then
            echo "NO_CHANGES=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ No actual changes after sync"
          else
            echo "NO_CHANGES=false" >> $GITHUB_OUTPUT
            echo "ğŸ”„ Changes detected - will commit"
          fi
      
      - name: ğŸ“ Commit and push changes
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true' && steps.check-actual-changes.outputs.NO_CHANGES == 'false'
        run: |
          echo "ğŸ“ Committing auto-synced changes..."
          
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all changed files
          git add -A
          
          # Create commit message
          COMMIT_MSG="ğŸ¨ Auto-sync: Update design tokens, controls, and stories
          
          - ğŸ”„ Synced design tokens from Figma/design files
          - âš™ï¸ Generated latest Storybook controls
          - ğŸ“ Updated stories with new token options
          - ğŸ¤– Automated by GitHub Actions
          
          Triggered by: ${{ github.event_name }} on ${{ github.ref }}"
          
          # Commit
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          
          # Push
          git push origin ${{ github.ref }} || echo "No changes to push"
          
          echo "âœ… Changes committed and pushed"
      
      - name: ğŸ§ª Build Storybook (validation)
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true'
        run: |
          echo "ğŸ§ª Building Storybook to validate changes..."
          npm run build-storybook
          echo "âœ… Storybook builds successfully"
      
      - name: âœ… Sync complete
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'true'
        run: |
          echo "ğŸ‰ AUTO-SYNC COMPLETE!"
          echo "âœ… Design tokens synced"
          echo "âœ… Storybook controls generated"
          echo "âœ… Stories updated"
          echo "âœ… Changes committed and pushed"
          echo "âœ… Storybook builds successfully"
      
      - name: ğŸ“ No changes needed
        if: steps.check-changes.outputs.TOKENS_CHANGED == 'false'
        run: |
          echo "ğŸ“ No token changes detected"
          echo "âœ… Nothing to sync"
      
      - name: ğŸ¯ Summary
        run: |
          echo "ğŸ¯ WORKFLOW SUMMARY"
          echo "=================="
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Tokens changed: ${{ steps.check-changes.outputs.TOKENS_CHANGED }}"
          if [[ "${{ steps.check-changes.outputs.TOKENS_CHANGED }}" == "true" ]]; then
            echo "Actual changes: ${{ steps.check-actual-changes.outputs.NO_CHANGES }}"
            echo "Status: ${{ steps.check-actual-changes.outputs.NO_CHANGES == 'false' && 'âœ… Synced and committed' || 'ğŸ“ Synced but no changes' }}"
          fi
