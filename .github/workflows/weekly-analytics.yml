name: 📊 Weekly Design Token Analytics

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      include_trends:
        description: 'Include historical trend analysis'
        required: false
        default: 'true'
        type: boolean
      email_report:
        description: 'Send email report to team'
        required: false
        default: 'false'
        type: boolean

jobs:
  generate-analytics:
    name: 📊 Generate Weekly Analytics
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for trend analysis
      
      - name: 📦 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ⚡ Install dependencies
        run: npm ci
      
      - name: 📊 Generate comprehensive analytics
        run: |
          echo "Generating weekly design token analytics..."
          
          # Generate current analytics
          npm run tokens:analytics collect
          npm run tokens:analytics report --html
          
          # Create weekly report
          mkdir -p reports/weekly
          
          # Copy analytics to weekly report directory
          cp -r .tokens-analytics/* reports/weekly/
          
          # Generate date stamp
          echo "$(date '+%Y-%m-%d')" > reports/weekly/report-date.txt
      
      - name: 📈 Generate trend analysis (if enabled)
        if: github.event.inputs.include_trends == 'true' || github.event_name == 'schedule'
        run: |
          echo "Generating historical trend analysis..."
          
          # Create trends directory
          mkdir -p reports/weekly/trends
          
          # Get token usage over time (simplified version)
          echo "Analyzing token usage trends over the past 4 weeks..."
          
          # This would ideally compare with previous analytics data
          # For now, we'll create a summary
          cat > reports/weekly/trends/summary.md << 'EOF'
          # Design Token Usage Trends
          
          ## Weekly Summary
          
          - **Report Date:** $(cat reports/weekly/report-date.txt)
          - **Total Tokens Analyzed:** [Generated from analytics]
          - **Most Used Token:** [Generated from analytics]
          - **Least Used Tokens:** [Generated from analytics]
          
          ## Key Insights
          
          1. **Token Adoption:** Review usage patterns
          2. **Unused Tokens:** Consider deprecating rarely used tokens
          3. **Consistency:** Check for token misuse across components
          
          ## Recommendations
          
          - Review tokens with single usage
          - Consider consolidating similar tokens
          - Update documentation for frequently used tokens
          EOF
      
      - name: 📝 Create detailed report
        run: |
          # Create comprehensive markdown report
          cat > reports/weekly/README.md << 'EOF'
          # Weekly Design Token Analytics Report
          
          **Generated:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ## 📊 Quick Stats
          
          - **Files Scanned:** [Auto-populated from analytics]
          - **Unique Tokens:** [Auto-populated from analytics]  
          - **Total Usage Count:** [Auto-populated from analytics]
          - **Components Analyzed:** [Auto-populated from analytics]
          
          ## 📈 Reports Available
          
          - [📊 Interactive Analytics Report](./analytics-report.html)
          - [📄 JSON Data Export](./analytics-data.json)
          - [📈 Trend Analysis](./trends/summary.md) *(if enabled)*
          
          ## 🎯 Action Items
          
          Based on this week's analysis, consider:
          
          1. **Review Unused Tokens:** Check tokens with minimal usage
          2. **Optimize Frequent Tokens:** Ensure most-used tokens are well-documented
          3. **Component Consistency:** Verify token usage across components
          
          ## 📚 Resources
          
          - [Design Token Documentation](../DESIGN_TOKENS.md)
          - [Token Usage Guidelines](https://github.com/your-org/design-system)
          - [Report an Issue](https://github.com/your-org/repo/issues/new)
          
          ---
          
          *This report was automatically generated by design-tokens-sync*
          EOF
      
      - name: 📤 Upload analytics artifacts
        uses: actions/upload-artifact@v4
        with:
          name: weekly-analytics-${{ github.run_number }}
          path: reports/weekly/
          retention-days: 90  # Keep weekly reports for 3 months
      
      - name: 📋 Create GitHub issue with summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read analytics data if available
            let analyticsData = null;
            try {
              const analyticsFiles = fs.readdirSync('.tokens-analytics')
                .filter(f => f.endsWith('.json'));
              
              if (analyticsFiles.length > 0) {
                const analyticsPath = path.join('.tokens-analytics', analyticsFiles[0]);
                analyticsData = JSON.parse(fs.readFileSync(analyticsPath, 'utf8'));
              }
            } catch (e) {
              console.log('Could not read analytics data:', e.message);
            }
            
            const reportDate = new Date().toISOString().split('T')[0];
            
            let statsSection = '';
            if (analyticsData && analyticsData.stats) {
              const stats = analyticsData.stats;
              statsSection = `
            ## 📊 This Week's Numbers
            
            - **Files Scanned:** ${stats.filesScanned || 'N/A'}
            - **Unique Tokens:** ${stats.uniqueTokens || 'N/A'}
            - **Total Usage Count:** ${stats.totalUsages || 'N/A'}
            - **Components Analyzed:** ${stats.componentsAnalyzed || 'N/A'}
            
            ### Most Used Token
            ${stats.mostUsedToken ? `**${stats.mostUsedToken.token}** - ${stats.mostUsedToken.count} uses` : 'No data available'}
            
            ### Potentially Unused Tokens
            ${stats.leastUsedTokens && stats.leastUsedTokens.length > 0 
              ? stats.leastUsedTokens.slice(0, 3).map(t => `- \`${t.token}\` (${t.count} use)`).join('\n')
              : 'No unused tokens detected'}`;
            }
            
            const issueBody = `# 📊 Weekly Design Token Analytics Report
            
            **Report Date:** ${reportDate}
            ${statsSection}
            
            ## 📈 Analytics Report
            
            A comprehensive analytics report has been generated and is available in the workflow artifacts.
            
            ### Available Reports:
            - 📊 Interactive HTML report
            - 📄 Raw JSON data export
            ${github.event.inputs.include_trends === 'true' || github.event_name === 'schedule' ? '- 📈 Historical trend analysis' : ''}
            
            ## 🎯 Recommended Actions
            
            1. **Review the full analytics report** in the workflow artifacts
            2. **Check for unused tokens** and consider deprecation
            3. **Validate token consistency** across components
            4. **Update documentation** for frequently used tokens
            
            ## 📦 Artifacts
            
            Download the complete report from [Workflow Run #${context.runNumber}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).
            
            ---
            
            *This issue was automatically created by the weekly analytics workflow. Close this issue when the report has been reviewed.*
            
            /label analytics weekly-report`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `📊 Weekly Design Token Analytics - ${reportDate}`,
              body: issueBody,
              labels: ['analytics', 'weekly-report', 'design-tokens']
            });
      
      - name: 📧 Send email report (if enabled)
        if: github.event.inputs.email_report == 'true' && env.SENDGRID_API_KEY != ''
        env:
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          TEAM_EMAIL: ${{ secrets.TEAM_EMAIL }}
        run: |
          # This would send an email with the report summary
          # Implementation depends on your email service
          echo "Email reporting would be implemented here"
          echo "Report would be sent to: $TEAM_EMAIL"
      
      - name: 🔄 Cleanup old reports
        run: |
          # Clean up analytics cache to save space
          rm -rf .tokens-sync-cache.json 2>/dev/null || true
          
          echo "## 📊 Weekly Analytics Complete" >> $GITHUB_STEP_SUMMARY
          echo "Design token analytics have been generated successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Reports:" >> $GITHUB_STEP_SUMMARY
          echo "- Interactive HTML analytics report" >> $GITHUB_STEP_SUMMARY
          echo "- JSON data export for further analysis" >> $GITHUB_STEP_SUMMARY
          echo "- GitHub issue with summary and action items" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "📦 **Download the complete report from the workflow artifacts.**" >> $GITHUB_STEP_SUMMARY 