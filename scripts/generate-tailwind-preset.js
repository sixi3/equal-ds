#!/usr/bin/env node

/**
 * Generate Tailwind Preset Files
 * Extracts theme.extend from tailwind.config.js and creates preset files
 * for consumers to import
 */

import fs from 'fs'
import path from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const projectRoot = path.resolve(__dirname, '..')
const tailwindConfigPath = path.join(projectRoot, 'tailwind.config.js')
const presetEsmPath = path.join(projectRoot, 'tokens.tailwind.preset.js')
const presetCjsPath = path.join(projectRoot, 'tokens.tailwind.preset.cjs')

function generatePresetFiles() {
  try {
    // Read the tailwind config
    if (!fs.existsSync(tailwindConfigPath)) {
      console.log('⚠️  tailwind.config.js not found, skipping preset generation')
      return
    }

    const configContent = fs.readFileSync(tailwindConfigPath, 'utf8')

    // Find the start of theme.extend by looking for "extend": {
    const extendStartMatch = configContent.match(/"extend":\s*\{/m)
    if (!extendStartMatch) {
      console.error('❌ Could not find theme.extend in tailwind.config.js')
      process.exit(1)
    }

    const startIndex = extendStartMatch.index + extendStartMatch[0].length - 1 // Position at opening brace
    
    // Extract the extend object by counting braces
    let braceCount = 0
    let inString = false
    let stringChar = null
    let extendEndIndex = startIndex
    
    for (let i = startIndex; i < configContent.length; i++) {
      const char = configContent[i]
      const prevChar = i > 0 ? configContent[i - 1] : ''
      
      // Handle strings (skip braces inside strings)
      if (!inString && (char === '"' || char === "'")) {
        inString = true
        stringChar = char
      } else if (inString && char === stringChar && prevChar !== '\\') {
        inString = false
        stringChar = null
      }
      
      if (!inString) {
        if (char === '{') braceCount++
        if (char === '}') {
          braceCount--
          if (braceCount === 0) {
            extendEndIndex = i + 1
            break
          }
        }
      }
    }
    
    // Extract the extend object content
    const themeExtendJson = configContent.substring(startIndex, extendEndIndex)
    
    // Clean up any trailing commas before closing braces
    const cleanedExtend = themeExtendJson.replace(/,(\s*[}\]])/g, '$1')

    // Generate ESM preset file
    const esmPreset = `/** @type {import('tailwindcss').Config} */
// Tailwind Preset - Auto-generated from design tokens
// Do not edit this file manually

export default {
  theme: {
    extend: ${cleanedExtend}
  }
}
`

    // Generate CommonJS preset file
    const cjsPreset = `/** @type {import('tailwindcss').Config} */
// Tailwind Preset - Auto-generated from design tokens
// Do not edit this file manually

module.exports = {
  theme: {
    extend: ${cleanedExtend}
  }
}
`

    // Write preset files
    fs.writeFileSync(presetEsmPath, esmPreset, 'utf8')
    fs.writeFileSync(presetCjsPath, cjsPreset, 'utf8')

    console.log('✅ Generated tokens.tailwind.preset.js (ESM)')
    console.log('✅ Generated tokens.tailwind.preset.cjs (CommonJS)')
  } catch (error) {
    console.error('❌ Error generating preset files:', error.message)
    process.exit(1)
  }
}

generatePresetFiles()

